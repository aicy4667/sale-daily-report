/**
 * --- éƒ¨ç½²æŒ‡å— (Deployment Guide) ---
 * * è‹¥è¦éƒ¨ç½²æ­¤å°ˆæ¡ˆåˆ° Vercelï¼Œè«‹ç¢ºä¿æ‚¨çš„ package.json åŒ…å«ä»¥ä¸‹ä¾è³´ï¼š
 * 1. lucide-react (ç”¨æ–¼åœ–æ¨™)
 * 2. tailwindcss (ç”¨æ–¼æ¨£å¼)
 * * æœ¬æª”æ¡ˆæ‡‰æ›¿æ›æ‚¨ Vite å°ˆæ¡ˆä¸­çš„ src/App.jsx
 */

import React, { useState } from 'react';
import { Plus, Trash2, Printer, Download, FileText, User, MapPin, MessageSquare, Briefcase, Info, FileDown } from 'lucide-react';

const App = () => {
  // åŸºæœ¬è³‡è¨Šç‹€æ…‹
  const [reportDate, setReportDate] = useState(new Date().toISOString().split('T')[0]);
  const [salesName, setSalesName] = useState('');
  const [department, setDepartment] = useState('');
  
  // ç‹€æ…‹æç¤ºè¨Šæ¯
  const [statusMessage, setStatusMessage] = useState('');

  // æ‹œè¨ªç´€éŒ„åˆ—è¡¨ç‹€æ…‹
  const [visits, setVisits] = useState([
    { id: 1, storeName: '', contactPerson: '', content: '', nextStep: '', result: '' }
  ]);

  // ä¸»ç®¡æºé€šæ¬„ç‹€æ…‹
  const [noteToSupervisor, setNoteToSupervisor] = useState('');

  // æ–°å¢ä¸€ç­†æ‹œè¨ªç´€éŒ„
  const addVisit = () => {
    const newId = visits.length > 0 ? Math.max(...visits.map(v => v.id)) + 1 : 1;
    setVisits([...visits, { id: newId, storeName: '', contactPerson: '', content: '', nextStep: '', result: '' }]);
  };

  // åˆªé™¤ä¸€ç­†æ‹œè¨ªç´€éŒ„
  const removeVisit = (id) => {
    if (visits.length > 1) {
      setVisits(visits.filter(v => v.id !== id));
    }
  };

  // æ›´æ–°æ‹œè¨ªç´€éŒ„å…§å®¹
  const updateVisit = (id, field, value) => {
    setVisits(visits.map(v => v.id === id ? { ...v, [field]: value } : v));
  };

  // --- æ ¸å¿ƒè§£æ±ºæ–¹æ¡ˆï¼šç”Ÿæˆä¸¦ä¸‹è¼‰ç¨ç«‹ HTML æª”æ¡ˆ ---
  // æ­¤åŠŸèƒ½åœ¨ Vercel éƒ¨ç½²å¾ŒåŒæ¨£æœ‰æ•ˆï¼Œå› ç‚ºå®ƒæ˜¯ç´”å‰ç«¯ç”Ÿæˆçš„
  const handleExportHTML = () => {
    setStatusMessage('æ­£åœ¨ç”Ÿæˆæª”æ¡ˆ...');

    // 1. æ§‹å»ºæ‹œè¨ªç´€éŒ„çš„ HTML å­—ä¸²
    const visitsHTML = visits.map(v => `
      <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.25rem; margin-bottom: 1.5rem; break-inside: avoid;">
        <div style="display: grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap: 1rem;">
          <div style="grid-column: span 8 / span 8;">
             <div style="font-size: 0.75rem; font-weight: 700; color: #6b7280; margin-bottom: 0.25rem;">åº—å®¶åç¨± / å®¢æˆ¶</div>
             <div style="font-size: 1.125rem; font-weight: 700; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem;">${v.storeName || '&nbsp;'}</div>
          </div>
          <div style="grid-column: span 4 / span 4;">
             <div style="font-size: 0.75rem; font-weight: 700; color: #6b7280; margin-bottom: 0.25rem;">å°æ¥äººå“¡</div>
             <div style="font-size: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem;">${v.contactPerson || '&nbsp;'}</div>
          </div>
          <div style="grid-column: span 12 / span 12; margin-top: 0.5rem;">
             <div style="font-size: 0.75rem; font-weight: 700; color: #6b7280; margin-bottom: 0.25rem;">æ‹œè¨ªå…§å®¹</div>
             <div style="font-size: 0.875rem; line-height: 1.625; white-space: pre-wrap; background-color: #f9fafb; padding: 0.5rem; border-radius: 0.25rem;">${v.content || 'ç„¡å…§å®¹'}</div>
          </div>
          <div style="grid-column: span 8 / span 8; margin-top: 0.25rem;">
             <div style="font-size: 0.75rem; font-weight: 700; color: #2563eb; margin-bottom: 0.25rem;">å¾ŒçºŒè·Ÿé€² (Next Steps)</div>
             <div style="font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem;">${v.nextStep || '&nbsp;'}</div>
          </div>
          <div style="grid-column: span 4 / span 4; margin-top: 0.25rem;">
             <div style="font-size: 0.75rem; font-weight: 700; color: #16a34a; margin-bottom: 0.25rem;">æ´½è«‡çµæœ / æ¥­ç¸¾</div>
             <div style="font-size: 0.875rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.25rem;">${v.result || '&nbsp;'}</div>
          </div>
        </div>
      </div>
    `).join('');

    // 2. æ§‹å»ºå®Œæ•´çš„ HTML é é¢
    const fullContent = `
      <!DOCTYPE html>
      <html lang="zh-TW">
      <head>
        <meta charset="UTF-8">
        <title>æ¥­å‹™æ—¥å ±è¡¨_${reportDate}</title>
        <style>
          body { font-family: system-ui, -apple-system, sans-serif; color: #1f2937; padding: 40px; max-width: 900px; margin: 0 auto; }
          @media print { body { padding: 0; } .no-print { display: none; } }
          .header { display: flex; justify-content: space-between; align-items: flex-end; border-bottom: 2px solid #1e40af; padding-bottom: 1rem; margin-bottom: 2rem; }
          .title { font-size: 1.875rem; font-weight: 700; }
          .sub-title { color: #6b7280; font-size: 0.875rem; margin-top: 0.5rem; }
          .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; background-color: #eff6ff; padding: 1rem; border-radius: 0.25rem; margin-bottom: 2rem; border: 1px solid #dbeafe; }
          .info-item label { display: block; font-size: 0.75rem; font-weight: 700; color: #1e40af; text-transform: uppercase; margin-bottom: 0.25rem; }
          .info-item div { font-size: 1.125rem; font-weight: 500; border-bottom: 1px solid #d1d5db; padding-bottom: 0.25rem; }
          .section-title { font-size: 1.125rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; color: #1f2937; }
          .footer-section { display: grid; grid-template-columns: 1fr; gap: 2rem; margin-top: 2rem; page-break-inside: avoid; }
          .supervisor-box { border: 2px solid #1f2937; border-radius: 0.5rem; overflow: hidden; }
          .box-header { background-color: #1f2937; color: white; padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 700; display: flex; justify-content: space-between; }
          .box-content { height: 8rem; padding: 1rem; position: relative; }
          .signature-line { position: absolute; bottom: 1rem; right: 1rem; width: 12rem; border-bottom: 1px solid #9ca3af; text-align: right; font-size: 0.75rem; color: #9ca3af; padding-bottom: 0.25rem; }
          .print-hint { background-color: #fef3c7; border: 1px solid #f59e0b; color: #92400e; padding: 10px; text-align: center; margin-bottom: 20px; border-radius: 6px; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="no-print print-hint">ğŸ’¡ æç¤ºï¼šè«‹æŒ‰ Ctrl+P (æˆ– Cmd+P) åˆ—å°æ­¤é é¢æˆ–å¦å­˜ç‚º PDF</div>
        
        <header class="header">
          <div>
            <div class="title">æ¥­å‹™æ‹œè¨ªæ—¥å ±è¡¨</div>
            <div class="sub-title">Daily Sales Report</div>
          </div>
          <div>
            <span style="font-weight: 600; color: #4b5563;">æ—¥æœŸï¼š</span>
            <span style="font-size: 1.125rem;">${reportDate}</span>
          </div>
        </header>

        <section class="info-grid">
          <div class="info-item">
            <label>æ¥­å‹™å§“å (Sales Rep)</label>
            <div>${salesName || '&nbsp;'}</div>
          </div>
          <div class="info-item">
            <label>éƒ¨é–€/å€åŸŸ (Department)</label>
            <div>${department || '&nbsp;'}</div>
          </div>
        </section>

        <section>
          <div class="section-title">æœ¬æ—¥æ‹œè¨ªç´€éŒ„</div>
          ${visitsHTML}
        </section>

        <div class="footer-section">
           <div style="border: 1px solid #d1d5db; border-radius: 0.5rem; padding: 1rem; background-color: #fefce8;">
              <div style="font-size: 0.875rem; font-weight: 700; color: #374151; margin-bottom: 0.5rem;">æ¥­å‹™å‚™è¨» / éœ€ä¸»ç®¡å”åŠ©äº‹é …</div>
              <div style="font-size: 0.875rem; white-space: pre-wrap;">${noteToSupervisor || 'ç„¡'}</div>
           </div>

           <div class="supervisor-box">
              <div class="box-header">
                  <span>ä¸»ç®¡æºé€š / æ‰¹ç¤ºæ¬„</span>
                  <span style="font-weight: 400; color: #d1d5db; font-size: 0.75rem;">è«‹ä¸»ç®¡æ–¼æ­¤è™•ç°½æ ¸</span>
              </div>
              <div class="box-content">
                  <div class="signature-line">ä¸»ç®¡ç°½ç« </div>
              </div>
           </div>
        </div>
        
        <footer style="margin-top: 2rem; text-align: center; font-size: 0.75rem; color: #9ca3af;">
          è¡¨å–®ç”Ÿæˆæ™‚é–“ï¼š${new Date().toLocaleString('zh-TW')}
        </footer>
      </body>
      </html>
    `;

    // 3. è§¸ç™¼ä¸‹è¼‰
    const blob = new Blob([fullContent], { type: 'text/html' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `æ¥­å‹™æ—¥å ±_${salesName}_${reportDate}.html`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    setStatusMessage('æª”æ¡ˆä¸‹è¼‰æˆåŠŸï¼è«‹é–‹å•Ÿè©²æª”æ¡ˆé€²è¡Œåˆ—å°');
    setTimeout(() => setStatusMessage(''), 5000);
  };

  return (
    <div className="min-h-screen bg-gray-100 p-4 md:p-8 font-sans text-gray-800">
      
      {/* æ“ä½œæ§åˆ¶åˆ— */}
      <div className="max-w-4xl mx-auto mb-6 flex flex-col sm:flex-row justify-between items-center print:hidden bg-white p-4 rounded-lg shadow-sm border border-gray-200 gap-4">
        <div>
          <h1 className="text-xl font-bold text-blue-800 flex items-center gap-2">
            <FileText className="w-6 h-6" />
            æ¥­å‹™æ—¥å ±ç”Ÿæˆå™¨
          </h1>
          <p className="text-sm text-gray-500 mt-1">ç„¡æ³•åˆ—å°ï¼Ÿè«‹æ”¹ç”¨å³å´çš„ã€ŒåŒ¯å‡ºæª”æ¡ˆã€åŠŸèƒ½</p>
        </div>
        
        {/* æŒ‰éˆ•å€åŸŸï¼šæ”¹ç‚ºå–®ä¸€å¼·åŠ›æŒ‰éˆ• */}
        <div className="flex flex-col items-end gap-2">
          <button 
            onClick={handleExportHTML}
            className="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg flex items-center gap-2 shadow-lg transition-all font-bold active:scale-95 transform hover:-translate-y-0.5"
            title="ä¸‹è¼‰å®Œæ•´æ ¼å¼çš„æª”æ¡ˆï¼Œä»¥ä¾¿åˆ—å°"
          >
            <FileDown className="w-6 h-6" />
            åŒ¯å‡ºæª”æ¡ˆ (ä¾›åˆ—å°/PDF)
          </button>
          
          {/* ç‹€æ…‹æç¤ºæ–‡å­— */}
          {statusMessage && (
            <div className="text-sm text-green-600 font-bold animate-pulse flex items-center gap-1 bg-green-50 px-2 py-1 rounded">
              <Info className="w-4 h-4" />
              {statusMessage}
            </div>
          )}
        </div>
      </div>

      {/* é è¦½å€åŸŸ (åƒ…ä¾›ç·¨è¼¯æŸ¥çœ‹) */}
      <div className="max-w-4xl mx-auto bg-white shadow-lg print:shadow-none min-h-[297mm] relative p-8 md:p-12">
        <div className="absolute top-0 right-0 bg-yellow-100 text-yellow-800 text-xs px-2 py-1 rounded-bl">
          ç·¨è¼¯é è¦½æ¨¡å¼
        </div>
        
        {/* å ±è¡¨æ¨™é ­ */}
        <header className="border-b-2 border-blue-800 pb-4 mb-8">
          <div className="flex justify-between items-end">
            <div>
              <h2 className="text-3xl font-bold text-gray-900 tracking-wide">æ¥­å‹™æ‹œè¨ªæ—¥å ±è¡¨</h2>
              <p className="text-gray-500 mt-2 text-sm">Daily Sales Report</p>
            </div>
            <div className="text-right">
              <div className="flex items-center gap-2 justify-end mb-1">
                <span className="font-semibold text-gray-600">æ—¥æœŸï¼š</span>
                <input 
                  type="date" 
                  value={reportDate} 
                  onChange={(e) => setReportDate(e.target.value)}
                  className="border-b border-gray-300 focus:border-blue-600 outline-none text-right bg-transparent"
                />
              </div>
            </div>
          </div>
        </header>

        {/* æ¥­å‹™äººå“¡è³‡è¨Š */}
        <section className="grid grid-cols-2 gap-8 mb-8 bg-blue-50 p-4 rounded border border-blue-100">
          <div className="flex flex-col">
            <label className="text-xs font-bold text-blue-800 uppercase mb-1">æ¥­å‹™å§“å (Sales Rep)</label>
            <input 
              type="text" 
              placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å"
              value={salesName}
              onChange={(e) => setSalesName(e.target.value)}
              className="w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium text-lg"
            />
          </div>
          <div className="flex flex-col">
            <label className="text-xs font-bold text-blue-800 uppercase mb-1">éƒ¨é–€/å€åŸŸ (Department)</label>
            <input 
              type="text" 
              placeholder="ä¾‹ï¼šåŒ—å€æ¥­å‹™ä¸€éƒ¨"
              value={department}
              onChange={(e) => setDepartment(e.target.value)}
              className="w-full bg-transparent border-b border-gray-300 focus:border-blue-500 outline-none py-1 font-medium text-lg"
            />
          </div>
        </section>

        {/* æ‹œè¨ªå…§å®¹åˆ—è¡¨ */}
        <section className="mb-8">
          <div className="flex justify-between items-center mb-4 border-b border-gray-200 pb-2">
            <h3 className="text-lg font-bold text-gray-800 flex items-center gap-2">
              <Briefcase className="w-5 h-5 text-blue-600" />
              æœ¬æ—¥æ‹œè¨ªç´€éŒ„
            </h3>
            <button 
              onClick={addVisit}
              className="text-sm bg-green-100 text-green-700 hover:bg-green-200 px-3 py-1 rounded-full flex items-center gap-1 transition-colors"
            >
              <Plus className="w-4 h-4" /> æ–°å¢è¡Œç¨‹
            </button>
          </div>

          <div className="space-y-6">
            {visits.map((visit, index) => (
              <div key={visit.id} className="relative border border-gray-200 rounded-lg p-5 hover:shadow-md transition-shadow">
                {visits.length > 1 && (
                  <button 
                    onClick={() => removeVisit(visit.id)}
                    className="absolute top-4 right-4 text-gray-400 hover:text-red-500 p-1"
                    title="åˆªé™¤æ­¤ç´€éŒ„"
                  >
                    <Trash2 className="w-5 h-5" />
                  </button>
                )}

                <div className="grid grid-cols-1 md:grid-cols-12 gap-4">
                  <div className="md:col-span-8">
                    <div className="flex items-center gap-2 mb-1">
                      <MapPin className="w-4 h-4 text-gray-400" />
                      <label className="text-xs font-bold text-gray-500">åº—å®¶åç¨± / å®¢æˆ¶</label>
                    </div>
                    <input 
                      type="text" 
                      placeholder="è¼¸å…¥å®¢æˆ¶åç¨±"
                      value={visit.storeName}
                      onChange={(e) => updateVisit(visit.id, 'storeName', e.target.value)}
                      className="w-full font-bold text-lg border-b border-gray-200 focus:border-blue-500 outline-none pb-1 bg-transparent placeholder-gray-300"
                    />
                  </div>
                  <div className="md:col-span-4">
                    <div className="flex items-center gap-2 mb-1">
                      <User className="w-4 h-4 text-gray-400" />
                      <label className="text-xs font-bold text-gray-500">å°æ¥äººå“¡ & è·ç¨±</label>
                    </div>
                    <input 
                      type="text" 
                      placeholder="ä¾‹ï¼šé™³åº—é•·"
                      value={visit.contactPerson}
                      onChange={(e) => updateVisit(visit.id, 'contactPerson', e.target.value)}
                      className="w-full text-base border-b border-gray-200 focus:border-blue-500 outline-none pb-1 bg-transparent placeholder-gray-300"
                    />
                  </div>

                  <div className="md:col-span-12 mt-2">
                    <div className="flex items-center gap-2 mb-1">
                      <MessageSquare className="w-4 h-4 text-gray-400" />
                      <label className="text-xs font-bold text-gray-500">æ‹œè¨ªå…§å®¹ / æ´½è«‡é‡é»</label>
                    </div>
                    <textarea 
                      rows={3}
                      placeholder="è«‹è©³ç´°æè¿°ä»Šæ—¥æ´½è«‡äº‹é …ã€å®¢æˆ¶éœ€æ±‚ã€ç”¢å“åé¥‹..."
                      value={visit.content}
                      onChange={(e) => updateVisit(visit.id, 'content', e.target.value)}
                      className="w-full text-sm leading-relaxed border border-gray-200 rounded p-2 focus:border-blue-500 outline-none resize-none bg-gray-50"
                    />
                  </div>

                  <div className="md:col-span-8 mt-1">
                     <label className="text-xs font-bold text-blue-600 mb-1 block">å¾ŒçºŒè·Ÿé€² (Next Steps)</label>
                     <input 
                      type="text" 
                      placeholder="ä¾‹ï¼šä¸‹é€±ä¸‰å¯„é€å ±åƒ¹å–®"
                      value={visit.nextStep}
                      onChange={(e) => updateVisit(visit.id, 'nextStep', e.target.value)}
                      className="w-full text-sm border-b border-gray-200 focus:border-blue-500 outline-none pb-1 bg-transparent"
                    />
                  </div>
                   <div className="md:col-span-4 mt-1">
                     <label className="text-xs font-bold text-green-600 mb-1 block">æ´½è«‡çµæœ / æ¥­ç¸¾</label>
                     <input 
                      type="text" 
                      placeholder="ä¾‹ï¼šå·²ç°½ç´„"
                      value={visit.result}
                      onChange={(e) => updateVisit(visit.id, 'result', e.target.value)}
                      className="w-full text-sm border-b border-gray-200 focus:border-blue-500 outline-none pb-1 bg-transparent"
                    />
                  </div>
                </div>
              </div>
            ))}
          </div>
        </section>

        <div className="grid grid-cols-1 gap-8">
            <div className="border border-gray-300 rounded-lg p-4 bg-yellow-50/50">
                <h3 className="text-sm font-bold text-gray-700 mb-2">æ¥­å‹™å‚™è¨» / éœ€ä¸»ç®¡å”åŠ©äº‹é …</h3>
                <textarea 
                    rows={3}
                    placeholder="è‹¥æœ‰éœ€è¦ä¸»ç®¡å”åŠ©æˆ–ç‰¹åˆ¥èªªæ˜çš„å›°é›£ï¼Œè«‹å¡«å¯«æ–¼æ­¤..."
                    value={noteToSupervisor}
                    onChange={(e) => setNoteToSupervisor(e.target.value)}
                    className="w-full bg-transparent outline-none text-sm resize-none"
                />
            </div>

            <div className="border-2 border-gray-800 rounded-lg p-0 overflow-hidden">
                <div className="bg-gray-800 text-white px-4 py-2 text-sm font-bold flex justify-between">
                    <span>ä¸»ç®¡æºé€š / æ‰¹ç¤ºæ¬„</span>
                    <span className="font-normal text-gray-300 text-xs">è«‹ä¸»ç®¡æ–¼æ­¤è™•ç°½æ ¸èˆ‡å›é¥‹</span>
                </div>
                <div className="h-32 p-4 bg-white relative">
                    <div className="absolute bottom-4 right-4 w-48 border-b border-gray-400 text-right text-xs text-gray-400 pb-1">
                        ä¸»ç®¡ç°½ç« 
                    </div>
                    <div className="w-full h-full border-b border-dashed border-gray-200"></div>
                </div>
            </div>
        </div>

        <footer className="mt-8 text-center text-xs text-gray-400">
          <p>è¡¨å–®ç”Ÿæˆæ™‚é–“ï¼š{new Date().toLocaleString('zh-TW')} | Â© Company Internal Use</p>
        </footer>

      </div>
    </div>
  );
};

export default App;
